#!/usr/bin/env bash
set -eo pipefail

# Focus on the first window in current workspace
# Used to factorize common window focusing logic across dfzf scripts

first_window_info=$(swaymsg -t get_tree | jq -r '
def find_first_layout(wid):
  def get_parents: recurse(.nodes[]?) | select(.nodes[]?.id == wid);
  [get_parents] | map(select(.layout and .layout != "none")) | if length > 0 then .[0].layout else "none" end;

(recurse(.nodes[]?) | select(.app_id) | .id) as $first |
"\($first):\(find_first_layout($first))"' | head -1)

if [[ -n $first_window_info ]]; then
	first_window_id=$(echo "$first_window_info" | cut -d: -f1)
	layout=$(echo "$first_window_info" | cut -d: -f2)
	
	dfzf-mark --con-id "$first_window_id" --mark _dfzf-preview
	swaymsg "[con_id=$first_window_id] focus"
	dfzf-mark --con-id "$first_window_id" --mark _dfzf-preview
	
	echo "$layout"
fi
